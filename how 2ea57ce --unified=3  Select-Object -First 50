[33mcommit 2ea57cee1ae34a64ab7cd8ef945dcf5ba82dcb16[m
Author: laowangbot <zwjmht@gmail.com>
Date:   Sun Aug 17 06:08:56 2025 +0800

    Update csmain.py

[1mdiff --git a/csmain.py b/csmain.py[m
[1mindex 620e6b5..292214b 100644[m
[1m--- a/csmain.py[m
[1m+++ b/csmain.py[m
[36m@@ -459,3 +459,3 @@[m [mUSER_CREDENTIALS = {[m
 [m
[31m-app = Client("ygbybot_session", api_id=API_ID, api_hash=API_HASH, bot_token=BOT_TOKEN)[m
[32m+[m[32mapp = Client(f"{config['bot_id']}_session", api_id=config['api_id'], api_hash=config['api_hash'], bot_token=config['bot_token'])[m
 [m
[36m@@ -480,2 +480,3 @@[m [mdef save_login_data():[m
     try:[m
[32m+[m[32m        login_file = f"user_login_{config['bot_id']}.json"[m
         login_data = {[m
[36m@@ -484,7 +485,7 @@[m [mdef save_login_data():[m
         }[m
[31m-        with open("user_login.json", "w", encoding="utf-8") as f:[m
[32m+[m[32m        with open(login_file, "w", encoding="utf-8") as f:[m
             json.dump(login_data, f, ensure_ascii=False, indent=4)[m
[31m-        logging.info("ç™»å½•æ•°æ®å·²ä¿å­˜")[m
[32m+[m[32m        logging.info(f"[{config['bot_id']}] ç™»å½•æ•°æ®å·²ä¿å­˜åˆ° {login_file}")[m
     except Exception as e:[m
[31m-        logging.error(f"ä¿å­˜ç™»å½•æ•°æ®å¤±è´¥: {e}")[m
[32m+[m[32m        logging.error(f"[{config['bot_id']}] ä¿å­˜ç™»å½•æ•°æ®å¤±è´¥: {e}")[m
 [m
[36m@@ -494,4 +495,5 @@[m [mdef load_login_data():[m
     try:[m
[31m-        if os.path.exists("user_login.json"):[m
[31m-            with open("user_login.json", "r", encoding="utf-8") as f:[m
[32m+[m[32m        login_file = f"user_login_{config['bot_id']}.json"[m
[32m+[m[32m        if os.path.exists(login_file):[m
[32m+[m[32m            with open(login_file, "r", encoding="utf-8") as f:[m
                 login_data = json.load(f)[m
[36m@@ -499,5 +501,11 @@[m [mdef load_login_data():[m
                 login_attempts = login_data.get("login_attempts", {})[m
[31m-            logging.info("ç™»å½•æ•°æ®å·²åŠ è½½")[m
[32m+[m[32m            logging.info(f"[{config['bot_id']}] ç™»å½•æ•°æ®å·²ä» {login_file} åŠ è½½")[m
[32m+[m[32m        else:[m
[32m+[m[32m            logging.info(f"[{config['bot_id']}] ç™»å½•æ–‡ä»¶ {login_file} ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°ç™»å½•æ•°æ®")[m
[32m+[m[32m            logged_in_users = {}[m
[32m+[m[32m            login_attempts = {}[m
     except Exception as e:[m
[31m-        logging.error(f"åŠ è½½ç™»å½•æ•°æ®å¤±è´¥: {e}")[m
[32m+[m[32m        logging.error(f"[{config['bot_id']}] åŠ è½½ç™»å½•æ•°æ®å¤±è´¥: {e}")[m
[32m+[m[32m        logged_in_users = {}[m
[32m+[m[32m        login_attempts = {}[m
 [m
[36m@@ -1173,2 +1181,32 @@[m [masync def cooperative_sleep(task_obj: dict, seconds: int):[m
 [m
[32m+[m[32m# ==================== å¤šæœºå™¨äººé…ç½®ç®¡ç† ====================[m
[32m+[m[32mdef get_bot_config():[m
[32m+[m[32m    """è·å–æœºå™¨äººé…ç½®"""[m
[32m+[m[32m    # ä»ç¯å¢ƒå˜é‡è·å–æœºå™¨äººæ ‡è¯†[m
[32m+[m[32m    bot_id = os.environ.get('BOT_ID', 'main')[m
[32m+[m[32m    bot_name = os.environ.get('BOT_NAME', f'è€æ¹¿å§¬{bot_id}')[m
[32m+[m[32m    bot_version = os.environ.get('BOT_VERSION', 'å¤šæœºå™¨äººç‰ˆæœ¬')[m
[32m+[m[41m    [m
[32m+[m[32m    # ä»ç¯å¢ƒå˜é‡è·å–Telegramé…ç½®[m
[32m+[m[32m    api_id = os.environ.get('API_ID')[m
[32m+[m[32m    api_hash = os.environ.get('API_HASH')[m
[32m+[m[32m    bot_token = os.environ.get('BOT_TOKEN')[m
[32m+[m[41m    [m
[32m+[m[32m    if not all([api_id, api_hash, bot_token]):[m
[32m+[m[32m        raise ValueError("ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: API_ID, API_HASH, BOT_TOKEN")[m
[32m+[m[41m    [m
[32m+[m[32m    return {[m
[32m+[m[32m        'bot_id': bot_id,[m
[32m+[m[32m        'bot_name': bot_name,[m
[32m+[m[32m        'bot_version': bot_version,[m
[32m+[m[32m        'api_id': api_id,[m
[32m+[m[32m        'api_hash': api_hash,[m
[32m+[m[32m        'bot_token': bot_token[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m# è·å–é…ç½®[m
[32m+[m[32mconfig = get_bot_config()[m
[32m+[m[32mprint(f"ğŸ¤– å¯åŠ¨æœºå™¨äºº: {config['bot_name']} - {config['bot_version']}")[m
[32m+[m[32mprint(f"ğŸ”‘ æœºå™¨äººID: {config['bot_id']}")[m
[32m+[m
 # ==================== æŒä¹…åŒ–å‡½æ•° ====================[m
[36m@@ -1176,5 +1214,6 @@[m [mdef save_configs():[m
     """å°†ç”¨æˆ·é…ç½®ä¿å­˜åˆ°æ–‡ä»¶"""[m
[31m-    with open("user_configs.json", "w", encoding='utf-8') as f:[m
[32m+[m[32m    config_file = f"user_configs_{config['bot_id']}.json"[m
[32m+[m[32m    with open(config_file, "w", encoding='utf-8') as f:[m
         json.dump(user_configs, f, ensure_ascii=False, indent=4)[m
[31m-    logging.info("ç”¨æˆ·é…ç½®å·²ä¿å­˜ã€‚")[m
[32m+[m[32m    logging.info(f"[{config['bot_id']}] ç”¨æˆ·é…ç½®å·²ä¿å­˜åˆ° {config_file}ã€‚")[m
 [m
[36m@@ -1183,6 +1222,10 @@[m [mdef load_configs():[m
     global user_configs[m
[31m-    if os.path.exists("user_configs.json"):[m
[31m-        with open("user_configs.json", "r", encoding="utf-8") as f:[m
[32m+[m[32m    config_file = f"user_configs_{config['bot_id']}.json"[m
[32m+[m[32m    if os.path.exists(config_file):[m
[32m+[m[32m        with open(config_file, "r", encoding="utf-8") as f:[m
             user_configs = json.load(f)[m
[31m-        logging.info("ç”¨æˆ·é…ç½®å·²è½½å…¥ã€‚")[m
[32m+[m[32m        logging.info(f"[{config['bot_id']}] ç”¨æˆ·é…ç½®å·²ä» {config_file} è½½å…¥ã€‚")[m
[32m+[m[32m    else:[m
[32m+[m[32m        logging.info(f"[{config['bot_id']}] é…ç½®æ–‡ä»¶ {config_file} ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°é…ç½®ã€‚")[m
[32m+[m[32m        user_configs = {}[m
 [m
[36m@@ -1191,7 +1234,8 @@[m [mdef save_user_states():[m
     try:[m
[31m-        with open("user_states.json", "w", encoding='utf-8') as f:[m
[32m+[m[32m        config_file = f"user_states_{config['bot_id']}.json"[m
[32m+[m[32m        with open(config_file, "w", encoding='utf-8') as f:[m
             json.dump(user_states, f, ensure_ascii=False, indent=4)[m
[31m-        logging.info("ç”¨æˆ·çŠ¶æ€å·²ä¿å­˜ã€‚")[m
[32m+[m[32m        logging.info(f"[{config['bot_id']}] ç”¨æˆ·çŠ¶æ€å·²ä¿å­˜åˆ° {config_file}ã€‚")[m
     except Exception as e:[m
[31m-        logging.error(f"ä¿å­˜ç”¨æˆ·çŠ¶æ€å¤±è´¥: {e}")[m
[32m+[m[32m        logging.error(f"[{config['bot_id']}] ä¿å­˜ç”¨æˆ·çŠ¶æ€å¤±è´¥: {e}")[m
 [m
[36m@@ -1201,11 +1245,12 @@[m [mdef load_user_states():[m
     try:[m
[31m-        if os.path.exists("user_states.json"):[m
[31m-            with open("user_states.json", "r", encoding="utf-8") as f:[m
[32m+[m[32m        config_file = f"user_states_{config['bot_id']}.json"[m
[32m+[m[32m        if os.path.exists(config_file):[m
[32m+[m[32m            with open(config_file, "r", encoding="utf-8") as f:[m
                 user_states = json.load(f)[m
[31m-            logging.info("ç”¨æˆ·çŠ¶æ€å·²è½½å…¥ã€‚")[m
[32m+[m[32m            logging.info(f"[{config['bot_id']}] ç”¨æˆ·çŠ¶æ€å·²ä» {config_file} è½½å…¥ã€‚")[m
         else:[m
             user_states = {}[m
[31m-            logging.info("ç”¨æˆ·çŠ¶æ€æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç©ºçŠ¶æ€ã€‚")[m
[32m+[m[32m            logging.info(f"[{config['bot_id']}] ç”¨æˆ·çŠ¶æ€æ–‡ä»¶ {config_file} ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç©ºçŠ¶æ€ã€‚")[m
     except Exception as e:[m
[31m-        logging.error(f"è½½å…¥ç”¨æˆ·çŠ¶æ€å¤±è´¥: {e}")[m
[32m+[m[32m        logging.error(f"[{config['bot_id']}] è½½å…¥ç”¨æˆ·çŠ¶æ€å¤±è´¥: {e}")[m
         user_states = {}[m
[36m@@ -1214,5 +1259,6 @@[m [mdef save_history():[m
     """å°†å†å²è®°å½•ä¿å­˜åˆ°æ–‡ä»¶"""[m
[31m-    with open("user_history.json", "w", encoding="utf-8") as f:[m
[32m+[m[32m    config_file = f"user_history_{config['bot_id']}.json"[m
[32m+[m[32m    with open(config_file, "w", encoding="utf-8") as f:[m
         json.dump(user_history, f, ensure_ascii=False, indent=4)[m
[31m-    logging.info("å†å²è®°å½•å·²ä¿å­˜ã€‚")[m
[32m+[m[32m    logging.info(f"[{config['bot_id']}] å†å²è®°å½•å·²ä¿å­˜åˆ° {config_file}ã€‚")[m
 [m
[36m@@ -1221,4 +1267,5 @@[m [mdef load_history():[m
     global user_history[m
[31m-    if os.path.exists("user_history.json"):[m
[31m-        with open("user_history.json", "r", encoding="utf-8") as f:[m
[32m+[m[32m    config_file = f"user_history_{config['bot_id']}.json"[m
[32m+[m[32m    if os.path.exists(config_file):[m
[32m+[m[32m        with open(config_file, "r", encoding="utf-8") as f:[m
             user_history = json.load(f)[m
[36m@@ -6238,2 +6285,68 @@[m [mdef validate_user_config(config):[m
 [m
[32m+[m[32m# ==================== ç«¯å£ç»‘å®šå’Œå¿ƒè·³æœºåˆ¶ ====================[m
[32m+[m[32mdef start_port_server():[m
[32m+[m[32m    """å¯åŠ¨ç«¯å£æœåŠ¡å™¨ï¼Œç”¨äºRender Web Service"""[m
[32m+[m[32m    try:[m
[32m+[m[32m        import socket[m
[32m+[m[32m        import http.server[m
[32m+[m[32m        import socketserver[m
[32m+[m[41m        [m
[32m+[m[32m        class SimpleHandler(http.server.BaseHTTPRequestHandler):[m
[32m+[m[32m            def do_GET(self):[m
[32m+[m[32m                self.send_response(200)[m
[32m+[m[32m                self.send_header('Content-type', 'text/html')[m
[32m+[m[32m                self.end_headers()[m
[32m+[m[32m                response = """[m
[32m+[m[32m                <html>[m
[32m+[m[32m                <head><title>æ¬è¿æœºå™¨äººæœåŠ¡</title></head>[m
[32m+[m[32m                <body>[m
[32m+[m[32m                <h1>ğŸ¤– {bot_name} - {bot_version}</h1>[m
[32m+[m[32m                <p>æœºå™¨äººID: {bot_id}</p>[m
[32m+[m[32m                <p>çŠ¶æ€ï¼šæ­£å¸¸è¿è¡Œä¸­</p>[m
[32m+[m[32m                <p>æ—¶é—´ï¼š{current_time}</p>[m
[32m+[m[32m                </body>[m
[32m+[m[32m                </html>[m
[32m+[m[32m                """.format([m
[32m+[m[32m                    bot_name=config['bot_name'],[m
[32m+[m[32m                    bot_version=config['bot_version'],[m
[32m+[m[32m                    bot_id=config['bot_id'],[m
[32m+[m[32m                    current_time=datetime.now().strftime("%Y-%m-%d %H:%M:%S")[m
[32m+[m[32m                )[m
[32m+[m[32m                self.wfile.write(response.encode())[m
[32m+[m[41m            [m
[32m+[m[32m            def log_message(self, format, *args):[m
[32m+[m[32m                # ç¦ç”¨HTTPè®¿é—®æ—¥å¿—[m
[32m+[m[32m                pass[m
[32m+[m[41m        [m
[32m+[m[32m        # ç»‘å®šåˆ°Renderåˆ†é…çš„ç«¯å£[m
[32m+[m[32m        port = int(os.environ.get('PORT', 8080))[m
[32m+[m[41m        [m
[32m+[m[32m        with socketserver.TCPServer(("", port), SimpleHandler) as httpd:[m
[32m+[m[32m            print(f"ğŸŒ [{config['bot_id']}] ç«¯å£æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£ {port}")[m
[32m+[m[32m            httpd.serve_forever()[m
[32m+[m[41m    [m
[32m+[m[32m    except Exception as e:[m
[32m+[m[32m        print(f"âš ï¸ [{config['bot_id']}] ç«¯å£æœåŠ¡å™¨å¯åŠ¨å¤±è´¥: {e}")[m
[32m+[m
[32m+[m[32mdef start_heartbeat():[m
[32m+[m[32m    """å¯åŠ¨å¿ƒè·³æœºåˆ¶ï¼Œé˜²æ­¢Render 15åˆ†é’Ÿè‡ªåŠ¨åœæ­¢"""[m
[32m+[m[32m    import requests[m
[32m+[m[32m    import time[m
[32m+[m[41m    [m
[32m+[m[32m    while True:[m
[32m+[m[32m        try:[m
[32m+[m[32m            # è·å–å½“å‰æœåŠ¡URL[m
[32m+[m[32m            service_url = os.environ.get('RENDER_EXTERNAL_URL')[m
[32m+[m[32m            if service_url:[m
[32m+[m[32m                # å‘è‡ªå·±çš„æœåŠ¡å‘é€è¯·æ±‚ï¼Œä¿æŒæ´»è·ƒ[m
[32m+[m[32m                response = requests.get(f"{service_url}/", timeout=10)[m
[32m+[m[32m                print(f"ğŸ’“ [{config['bot_id']}] å¿ƒè·³è¯·æ±‚æˆåŠŸ: {response.status_code}")[m
[32m+[m[32m            else:[m
[32m+[m[32m                print(f"ğŸ’“ [{config['bot_id']}] å¿ƒè·³æœºåˆ¶è¿è¡Œä¸­ï¼ˆæ— å¤–éƒ¨URLï¼‰")[m
[32m+[m[32m        except Exception as e:[m
[32m+[m[32m            print(f"ğŸ’“ [{config['bot_id']}] å¿ƒè·³è¯·æ±‚å¤±è´¥: {e}")[m
[32m+[m[41m        [m
[32m+[m[32m        # æ¯10åˆ†é’Ÿå‘é€ä¸€æ¬¡å¿ƒè·³[m
[32m+[m[32m        time.sleep(600)[m
[32m+[m
 # ==================== å¯åŠ¨æœºå™¨äºº ====================[m
[36m@@ -6245,2 +6358,12 @@[m [mif __name__ == "__main__":[m
     [m
[32m+[m[32m    # åœ¨åå°å¯åŠ¨ç«¯å£æœåŠ¡å™¨[m
[32m+[m[32m    import threading[m
[32m+[m[32m    port_thread = threading.Thread(target=start_port_server, daemon=True)[m
[32m+[m[32m    port_thread.start()[m
[32m+[m[41m    [m
[32m+[m[32m    # å¯åŠ¨å¿ƒè·³çº¿ç¨‹[m
[32m+[m[32m    heartbeat_thread = threading.Thread(target=start_heartbeat, daemon=True)[m
[32m+[m[32m    heartbeat_thread.start()[m
[32m+[m[32m    print(f"ğŸ’“ [{config['bot_id']}] å¿ƒè·³æœºåˆ¶å·²å¯åŠ¨ï¼Œæ¯10åˆ†é’Ÿå‘é€ä¸€æ¬¡è¯·æ±‚")[m
[32m+[m[41m    [m
     load_configs()[m
[36m@@ -6280,3 +6403,4 @@[m [mif __name__ == "__main__":[m
     print("=" * 60)[m
[31m-    print("âœ… å¯åŠ¨å®Œæˆï¼æœºå™¨äººçŠ¶æ€:")[m
[32m+[m[32m    print(f"âœ… å¯åŠ¨å®Œæˆï¼{config['bot_name']} çŠ¶æ€:")[m
[32m+[m[32m    print(f"   ğŸ”‘ æœºå™¨äººID: {config['bot_id']}")[m
     print(f"   ğŸ“¡ æ–°æ¬è¿å¼•æ“: {'âœ… å¯ç”¨' if NEW_ENGINE_AVAILABLE else 'âŒ ä¸å¯ç”¨'}")[m
